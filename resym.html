<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="main.css">
    <title>resym: Remote stack symbolication</title>
    <meta name="description" content="Remote stack symboication technique">
    <meta name="keywords" content="symbolicate, debuginfo, dwarf">
  </head>
  <body>
    <h1>resym: Remote stack symbolication</h1>
    <p>Debug information makes up a significant portion of the size of a binary.</p>
    <p>For applications that are distributed to end-users, it is common to strip debug information to reduce the size of the binary. This makes it difficult to debug crashes because the stack trace is not symbolicated. One way to work around this is to collect crash reports from users and symbolicate them manually.</p>
    <p>resym is a tool that collects and seralizes win64 stack traces into URF-safe strings without compromising user privacy. It can be used to symbolicate stack traces on a remote server.</p>
    <p><a href="https://github.com/littledivy/resym"><a href="https://github.com/littledivy/resym">https://github.com/littledivy/resym</a></a></p>
    <h2 class="!text-foreground">Design</h2>
    <h3>Stack walking</h3>
    <p>On x86_64 Windows, resym uses <code>RtlLookupFunctionEntry</code>-based stack unwinding to collect the instruction pointers, starting from the current %rip register.</p>
    <p>We first capture the caller’s context using <code>RtlCaptureContext</code> and then walk the stack using <code>RtlLookupFunctionEntry</code> and <code>RtlVirtualUnwind</code>. This requires thread to be suspended (except for the current thread) which is the case for panic handlers.</p>
    <pre><code data-lang="rust">std::panic::set_hook(<span style="color: #4b69c6">Box</span>::new(|_| {<br>  resym::win64::trace();<br>});</code></pre>
    <p>Before encoding, each stack address is calculated by subtracting the base address of the module that contains the address.</p>
    <h3>Representation</h3>
    <p>A “trace string” is a sequence of URL-safe Base64 VLQ-encoded strings. This string can be safely shared with the crash reporter and sent to a remote server for symbolication.</p>
    <pre><code data-lang="rust">std::panic::set_hook(<span style="color: #4b69c6">Box</span>::new(|info| {<br>  <span style="color: #74747c">//</span><span style="color: #74747c"> upvCsknB2z8xrB-w7xrB-0qxrBs15xrBonm5zBqsuB2sjC8gMiqiCylyvrB0niCy1uBwltmzBut0L4y_uB.</span><br>  <span style="color: #d73948">let</span> trace_str <span style="color: #d73948">=</span> resym::win64::trace();<br>}));</code></pre>
    <h3>Symbolication</h3>
    <p>resym’s symbolicate API decodes the trace string and finds the function frame using pdb-addr2line, the function frames are then passed to a formatter.</p>
    <pre><code data-lang="rust"><span style="color: #d73948">use</span> resym::{symbolicate, DefaultFormatter};<br><span style="color: #d73948">use</span> std::fs::File;<br><br><span style="color: #d73948">let</span> pdb <span style="color: #d73948">=</span> File::open(<span style="color: #198810">"</span><span style="color: #198810">path/to/symbols.pdb</span><span style="color: #198810">"</span>)<span style="color: #d73948">?</span>;<br><br><span style="color: #4b69c6">symbolicate</span>(<br>  pdb,<br>  trace_str,<br>  DefaultFormatter::new(<span style="color: #d73948">&amp;</span><span style="color: #d73948">mut</span> std::io::stdout()),<br>)<span style="color: #d73948">?</span>;</code></pre>
    <p>You can bring your own formatter too.</p>
    <pre><code data-lang="rust"><span style="color: #d73948">const</span> <span style="color: #b60157">CSS</span>: <span style="color: #d73948">&amp;</span><span style="color: #d73948">str</span> <span style="color: #d73948">=</span> <span style="color: #16718d">include_str!</span>(<span style="color: #198810">"</span><span style="color: #198810">style.css</span><span style="color: #198810">"</span>);<br><br><span style="color: #d73948">impl</span>&lt;<span style="color: #d73948">'a</span>> <span style="color: #4b69c6">HtmlFormatter</span>&lt;<span style="color: #d73948">'a</span>> {<br>  <span style="color: #d73948">fn</span> <span style="color: #4b69c6">new</span>(writer: <span style="color: #d73948">&amp;</span><span style="color: #d73948">'a</span> <span style="color: #d73948">mut</span> <span style="color: #4b69c6">Vec</span>&lt;<span style="color: #d73948">u8</span>>) -> <span style="color: #d73948">Self</span> {<br>    <span style="color: #d73948">let</span> <span style="color: #d73948">_</span> <span style="color: #d73948">=</span> <span style="color: #16718d">writeln!</span>(writer, <span style="color: #198810">"</span><span style="color: #198810">&lt;style></span><span style="color: #b60157">{}</span><span style="color: #198810">&lt;/style></span><span style="color: #198810">"</span>, <span style="color: #b60157">CSS</span>);<br>    <span style="color: #d73948">Self</span> { writer }<br>  }<br>}<br><br><span style="color: #d73948">impl</span> Formatter <span style="color: #d73948">for</span> <span style="color: #4b69c6">HtmlFormatter</span>&lt;'<span style="color: #d73948">_</span>> {<br>  <span style="color: #d73948">fn</span> <span style="color: #4b69c6">write_frames</span>(<br>    <span style="color: #d73948">&amp;</span><span style="color: #d73948">mut</span> self,<br>    addr: <span style="color: #d73948">u32</span>,<br>    frame: <span style="color: #d73948">&amp;</span>resym::pdb_addr2line::FunctionFrames,<br>  ) {<br>    <span style="color: #d73948">for</span> frame <span style="color: #d73948">in</span> <span style="color: #d73948">&amp;</span>frame.frames {<br>      <span style="color: #d73948">let</span> source_str <span style="color: #d73948">=</span><br>        <span style="color: #4b69c6">maybe_link_source</span>(frame.file.<span style="color: #4b69c6">as_deref</span>().<span style="color: #4b69c6">unwrap_or</span>(<span style="color: #198810">"</span><span style="color: #198810">??</span><span style="color: #198810">"</span>), frame.line);<br>      <span style="color: #d73948">let</span> <span style="color: #d73948">_</span> <span style="color: #d73948">=</span> <span style="color: #16718d">writeln!</span>(<br>        self.writer,<br>        <span style="color: #198810">"</span><span style="color: #198810">     &lt;li>0x</span><span style="color: #b60157">{:x}</span><span style="color: #198810">: &lt;code></span><span style="color: #b60157">{}</span><span style="color: #198810">&lt;/code> at </span><span style="color: #b60157">{}</span><span style="color: #198810">&lt;/li></span><span style="color: #198810">"</span>,<br>        addr,<br>        frame.function.<span style="color: #4b69c6">as_deref</span>().<span style="color: #4b69c6">unwrap_or</span>(<span style="color: #198810">"</span><span style="color: #198810">&lt;unknown></span><span style="color: #198810">"</span>),<br>        source_str,<br>      );<br>    }<br>  }<br>}</code></pre>
    <h2 class="!text-foreground">References</h2>
    <p><a href="https://docs.rs/pdb-addr2line/latest/pdb_addr2line/">https://docs.rs/pdb-addr2line/latest/pdb_addr2line/</a></p>
  </body>
</html>
